---
- hosts: PTP-WEB

  tasks:

  - name: Install packages
    apt:
      pkg:
      - apache2
      - php
      - php-mysql
      - screen
      update_cache: yes
      state: latest

  - name: Clone git repository
    git:
      repo: https://github.com/6ftClaud/push-to-production.git
      dest: /tmp/push-to-production
      clone: yes
      update: yes

  - name: Copy webpage files/configs
    copy:
      src: /tmp/push-to-production/web-for-virtualization/
      dest: /var/www/html
      remote_src: yes

  - name: Change directory permission
    file:
      path: /var/www/html/
      state: directory
      group: www-data
      recurse: yes
      mode: ug+rwx

  - name: Cleanup
    file:
      state: absent
      path: /tmp/push-to-production

  - name: Add IPs to /etc/hosts
    blockinfile:
      path: /etc/hosts
      block: "{{ lookup('file', '/srv/push-to-production/created_VMs.csv') }}"
      state: present
      insertafter: EOF

  - name: Restart Apache
    ansible.builtin.systemd:
      name: apache2
      state: reloaded

  - name: Enable webserver communication with database
    ansible.builtin.command: sleep 30 && screen -dmS php-server php -q /var/www/html/server.php
